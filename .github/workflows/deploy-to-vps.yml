name: Deploy to VPS

on:
  workflow_run:
    workflows: ['Push Docker Image']
    types: completed
    branches: ['main']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: /root/sizeupdashboard

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /root/sizeupdashboard
            echo "Pulling latest image..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/firstdue-listener:latest

            echo "Generating .env file..."
            cat <<EOF > .env
            NODE_ENV=production
            FIRSTDUE_API_KEY=${{ secrets.FIRSTDUE_API_KEY }}
            PORT=${{ secrets.PORT }}
            TIMEZONE=${{ vars.TIMEZONE }}
            LOG_LEVEL=${{ vars.LOG_LEVEL }}
            CONVEX_URL=${{ vars.CONVEX_URL }}
            WEATHER_API_KEY=${{ secrets.WEATHER_API_KEY }}
            WEATHER_LAT=${{ vars.WEATHER_LAT }}
            WEATHER_LNG=${{ vars.WEATHER_LNG }}
            WEATHER_UNITS=${{ vars.WEATHER_UNITS }}
            GITHUB_COMMIT_SHA=${{ github.sha }}
            API_KEY=${{ secrets.API_KEY }}
            CONVEX_API_KEY=${{ secrets.CONVEX_API_KEY }}
            EOF

            echo "Restarting containers..."
            docker-compose down || true
            docker-compose up -d

            echo "Deployment complete!"
